# 架构设计

## 概述

Pikachu'n 是一个基于 Go 语言开发的服务，用于监控 MySQL binlog 事件并将其作为 JSON 负载转发到配置的 webhook URL。该系统设计为轻量级、高效且可靠。

## 组件

### 1. 配置管理器
- 使用 Viper 进行配置管理
- 支持多种配置源（YAML、环境变量）
- 处理配置验证和默认值

### 2. MySQL Binlog 读取器
- 使用 go-mysql 库连接 MySQL 服务器
- 解析 binlog 事件（INSERT、UPDATE、DELETE）
- 处理不同的数据类型和特殊情况（如 JSON、BIT）

### 3. 事件处理器
- 处理原始 binlog 事件
- 将数据转换为结构化 JSON 格式
- 根据配置处理事件过滤

### 4. Webhook 分发器
- 将事件发送到配置的 webhook URL
- 实现带指数退避的重试机制
- 处理 HTTP 响应验证

### 5. 状态管理器
- 管理检查点持久化
- 实现断点续传功能
- 处理状态同步

### 6. Web 界面
- 使用 Gin 框架构建
- 提供监控和管理端点
- 实时事件显示

## 数据流

```
MySQL Binlog → Binlog 读取器 → 事件处理器 → Webhook 分发器 → Webhook URL
                                          ↓
                                    状态管理器
                                          ↓
                                   Web 界面
```

## 设计决策

### 1. 语言选择
选择 Go 的原因：
- 优秀的并发支持
- 强大的系统编程生态系统
- 良好的性能特征
- 简单的部署（单个二进制文件）

### 2. Binlog 解析
选择 go-mysql 库的原因：
- 专为 MySQL binlog 解析而构建
- 积极维护和社区支持
- 良好的性能和可靠性

### 3. Web 框架
选择 Gin 的原因：
- 高性能
- 简单的 API
- 良好的中间件支持
- 活跃的社区

### 4. 配置管理
选择 Viper 的原因：
- 支持多种配置格式
- 环境变量集成
- 配置热重载功能

## 可扩展性考虑

### 水平扩展
- 多个实例可以运行不同的表过滤器
- 通过外部存储共享状态（未来增强功能）

### 性能优化
- 高效的事件处理管道
- MySQL 和 HTTP 客户端的连接池
- 异步事件分发

## 安全考虑

### 数据保护
- Webhook URL 应使用 HTTPS
- 敏感配置可以通过环境变量传递
- 事件数据不会持久存储

### 访问控制
- 生产环境中应保护 Web 界面
- 配置文件应具有适当的权限